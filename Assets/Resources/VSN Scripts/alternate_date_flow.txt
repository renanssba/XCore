fade_out 0.7
bg null

wait 0.5
set_var currentDateEvent 0
theater_animation "setup_date"

move_camera "close_shot" 0

set_screen "date"
enable_input true
set_current_character_turn -1

fade_in 0.7

wait 0.5

theater_animation "party_enters"

say "char_name/none" "alternate_date_flow/say_0"


set_var last_enemy #dateLength
add_var last_enemy -1


for currentDateEvent #dateLength
  waypoint new_enemy_appears
  move_camera "battle_view" 0.5
  play_music "battle1_intro" "battle1_loop"
  wait 0.8

  set_var currentBattleTurn -1
  goto_script "\currentEventName" event_statement

  // if currentDateEvent == 0
    // say "\boy" "E agora, o que faremos?"
    // say "\girl" "Eu vou te proteger!"
  // else
    // say "\girl" "Fica comigo!"
    // say "\boy" "Vamos lutar juntos."
  // endif

  show_date_ui true
  wait 0.5

  goto_script "check_passive_triggers" "enemy_appears"


  waypoint start_new_turn

  add_var currentBattleTurn 1
  goto_script "check_passive_triggers" "turn_started"

  // PARTY MEMBERS receive effects from conditions (like take poison damage)
  // for currentPlayerTurn #partyLength
    // for currentStatusCondition #currentPlayerStatusConditionsCount
      // activate_status_condition_effect currentPlayerTurn currentStatusCondition
    // endfor
  // endfor

  // ENEMY receives effects from conditions
  // for currentStatusCondition #currentEnemyStatusConditionsCount
    // activate_status_condition_effect 3 currentStatusCondition
  // endfor
  // end turn (to pass time on status conditions)
  // end_turn


  // character action inputs
  for currentPlayerTurn #partyLength
    action_input currentPlayerTurn
  // endfor

  set_current_character_turn -1
  wait 0.5

  // execute player turn
  // for currentPlayerTurn #partyLength
    check_action_skip currentPlayerTurn

    // do actions
    character_action_description currentPlayerTurn
    character_action currentPlayerTurn

    // receive effects from conditions
    goto_script "check_passive_triggers" "after_action"
    for currentStatusCondition #currentPlayerStatusConditionsCount
      activate_status_condition_effect currentPlayerTurn currentStatusCondition
    endfor
    end_turn currentPlayerTurn

    // check death
    goto_script "check_passive_triggers" "before_death_checks"
    if #currentHp <= 0
      goto fail_date
    endif

    wait 0.5
    // if opponent is defeated, go to new event
    if #currentEnemyHp <= 0
      goto defeat_enemy
    endif
  endfor


  // if opponent is defeated, go to new event
  if #currentEnemyHp <= 0
    goto defeat_enemy
  endif


  // enemy turn
  set_var currentPlayerTurn 0
  enemy_attack_description
  goto_script "check_passive_triggers" "before_enemy_attack"
  enemy_attack
  goto_script "check_passive_triggers" "after_enemy_attack"

  // ENEMY receives effects from conditions
  for currentStatusCondition #currentEnemyStatusConditionsCount
    activate_status_condition_effect 3 currentStatusCondition
  endfor
  end_turn 3

  // if enemy is defeated, go to new enemy
  if #currentEnemyHp <= 0
    goto defeat_enemy
  endif



  goto_script "check_passive_triggers" "before_death_checks"
  if #currentHp <= 0
    goto fail_date
  endif

  goto start_new_turn
endfor




waypoint defeat_enemy
goto_script "\currentEventName" defeated
theater_animation "enemy_leaves"
challenge_result true
update_ui
play_sfx "ui_success"
wait 2

goto_script "check_passive_triggers" "enemy_defeated"

show_date_ui false
wait 0.5
fade_music 0 1
move_camera "close_shot" 1.5
wait 2
if daytime == 0
	play_music "observation_morning_intro" "observation_morning_loop"
else
	play_music "observation_afternoon_intro" "observation_afternoon_loop"
endif
wait 0.5
if currentDateEvent == last_enemy
  goto advance_battle
endif
if currentDateEvent == 0
  say "char_name/none" "alternate_date_flow/say_1"
  say "char_name/boy" "alternate_date_flow/say_2"
  say "char_name/girl" "alternate_date_flow/say_3"
  say "char_name/none" "alternate_date_flow/say_4"
endif
if currentDateEvent == 1
  say "char_name/none" "alternate_date_flow/say_5"
  say "char_name/boy" "alternate_date_flow/say_6"
  say "char_name/girl" "alternate_date_flow/say_7"
  say "char_name/none" "alternate_date_flow/say_8"
endif
if currentDateEvent > 1
  say "char_name/none" "alternate_date_flow/say_9"
endif
goto advance_battle


waypoint advance_battle
add_var currentDateEvent 1
if  currentDateEvent >= #dateLength
  goto win_date
else
  goto new_enemy_appears
endif





waypoint win_date
enable_input false
//say "" "Depois de muitos percalços..."
goto_script "cap1_date_end"
say "alternate_date_flow/char_name_0" "alternate_date_flow/say_10"
// show_date_ui false

if #currentDateId == 1
  add_exp 12
endif
if #currentDateId == 2
  add_exp 40
endif
if #currentDateId == 3
  add_exp 200
endif
open_heart_lock #currentDateId
goto end



waypoint fail_date
challenge_result false
update_ui
play_sfx "ui_fail"
wait 2
enable_input false
say "char_name/none" "alternate_date_flow/say_11"
say "char_name/boy" "alternate_date_flow/say_12"
say "char_name/girl" "alternate_date_flow/say_13"
say "char_name/none" "alternate_date_flow/say_14"
// show_date_ui false
goto end



waypoint end
end_date
goto_script "pass_time"

