fade_out 0.7
bg null

wait 0.5
set_var currentDateEvent 0
theater_animation "setup_date"

move_camera "close_shot" 0

set_screen "date"
enable_input true
set_current_character_turn -1

fade_in 0.7

wait 0.5

theater_animation "party_enters"
wait 1.5

say "" "\couple estavam andando tranquilamente em direção ao local \vsn(date_objective), quando de repente..."

/// DATE TUTORIAL (?)
// if tutorial_date == 0
  // goto_script "tutorial_date"
// endif


set_var last_enemy #dateLength
add_var last_enemy -1


for currentDateEvent #dateLength
  waypoint new_enemy_appears
  move_camera "battle_view" 0.5
  play_music "battle1_intro" "battle1_loop"
  wait 0.8

  theater_animation "enemy_enters"
  set_var currentBattleTurn -1
  wait 1.2

  goto_script "\currentEventName" event_statement
  // if currentDateEvent == 0
    // say "\boy" "E agora, o que faremos?"
    // say "\girl" "Eu vou te proteger!"
  // else
    // say "\girl" "Fica comigo!"
    // say "\boy" "Vamos lutar juntos."
  // endif

  show_date_ui true
  wait 0.5

  goto_script "check_passive_triggers" "enemy_appears"

  // if tutorial_date2 == 0
    // goto_script "tutorial_date2"
  // endif


  waypoint start_new_turn

  add_var currentBattleTurn 1
  goto_script "check_passive_triggers" "turn_started"

  // PARTY MEMBERS receive effects from conditions (like take poison damage)
  for currentPlayerTurn #partyLength
    for currentStatusCondition #currentPlayerStatusConditionsCount
      activate_status_condition_effect currentPlayerTurn currentStatusCondition
    endfor
  endfor

  // ENEMY receives effects from conditions
  for currentStatusCondition #currentEnemyStatusConditionsCount
    activate_status_condition_effect 3 currentStatusCondition
  endfor
  // end turn (to pass time on status conditions)
  end_turn


  if #currentHp <= 0
    goto fail_date
  endif


  // character action inputs
  for currentPlayerTurn #partyLength
    action_input currentPlayerTurn
  endfor

  set_current_character_turn -1
  wait 0.5

  // execute player actions
  for currentPlayerTurn #partyLength
    check_action_skip currentPlayerTurn
    character_action_description currentPlayerTurn
    character_action currentPlayerTurn
    goto_script "check_passive_triggers" "after_action"
    wait 0.5
  endfor

  // if oponent is defeated, go to new event
  if #currentChallengeHp <= 0
    goto_script "\currentEventName" defeated
    theater_animation "enemy_leaves"
    wait 0.7
    challenge_result true
    update_ui
    play_sfx "ui_success"
    wait 2

    goto_script "check_passive_triggers" "enemy_defeated"

    show_date_ui false
    wait 0.5
    fade_music 0 1
    move_camera "close_shot" 1.5
    wait 2
    play_music "observacao2_intro" "observacao2_loop"
    wait 0.5
    if currentDateEvent == last_enemy
      continue
    endif
    if currentDateEvent == 0
      say "" "O casal continua indo em direção ao seu objetivo."
      say "\boy" "Isso foi estranho, né?"
      say "\girl" "Sim, mas ainda bem que deu tudo certo."
      say "" "Subitamente, um novo desafio aparece..."
    endif
    if currentDateEvent == 1
      say "" "Após os ânimos se acalmarem, o casal continua conversando."
      say "\boy" "Então \girl, estamos quase chegando. Eu queria conversar com você sobre uma coisa..."
      say "\girl" "É mesmo? O que é?"
      say "" "Antes que \boy pudesse continuar..."
    endif
    if currentDateEvent > 1
      say "" "O casal sente que está chegando mais perto do seu objetivo, mas dessa vez..."
    endif
    continue
  endif


  // enemy turn
  set_var currentPlayerTurn 0
  enemy_attack_description
  goto_script "check_passive_triggers" "before_enemy_attack"
  enemy_attack
  goto_script "check_passive_triggers" "after_enemy_attack"

  if #currentHp <= 0
    goto fail_date
  endif

  goto start_new_turn
endfor




waypoint win_date
enable_input false
//say "" "Depois de muitos percalços..."
goto_script "cap1_date_end"
say "char_name/none" "date/say_4"
// show_date_ui false

if #currentDateId == 1
  add_exp 120
endif
if #currentDateId == 2
  add_exp 400
endif
if #currentDateId == 3
  add_exp 2000
endif
open_heart_lock #currentDateId
goto end


waypoint fail_date
challenge_result false
update_ui
play_sfx "ui_fail"
wait 2
enable_input false
say "" "\couple decidem que o encontro não está dando certo."
say "\boy" "Podemos continuar esse encontro outro dia..."
say "\girl" "Sim, com certeza será melhor..."
say "" "O encontro acabou de forma <color=red>insatisfatória</color>."
// show_date_ui false
goto end



waypoint end
full_heal_party
set_var battle_is_happening false
goto_script "pass_time"
