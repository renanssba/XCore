set_var battle_is_happening false
set_var currentDateEvent 0
setup_date

fade_out 0.5
bg null

wait 0.2
play_music "" "XCore1 Boss Theme"
wait 0.2

theater_animation "setup_battle"

// move_camera "far_view" 0
move_camera "battle_view" 0

set_screen "battle"
enable_input true
set_current_character_turn -1

fade_in 0.5



/// EXECUTE THE FIGHT
// for currentDateEvent #dateLength
  // set_var currentBattleTurn 0
  wait 0.5

  // waypoint start_new_turn
  goto_script "check_passive_triggers" "turn_started"

  // PARTY MEMBERS receive effects from conditions (like take poison damage)
  for currentPlayerTurn #partyLength
    for currentStatusCondition #currentPlayerStatusConditionsCount
      activate_status_condition_effect currentPlayerTurn currentStatusCondition
    endfor
  endfor

  // ENEMY receives effects from conditions
  for currentStatusCondition #currentEnemyStatusConditionsCount
    activate_status_condition_effect 3 currentStatusCondition
  endfor
  // end turn (to pass time on status conditions)
  end_turn

  goto_script "check_passive_triggers" "before_death_checks"
  
  /// TODO: check if all the party members are dead and end battle
  // if #currentHp <= 0
    // goto end
  // endif


  // character action inputs
  for currentPlayerTurn #partyLength

    // first battle tutorials
    // if tutorial_skills == false
      // goto_script "tutorials" "using_skills"
    // endif

    /// Skip action input if already selected
    // if input_already_selected == true
      // set_var input_already_selected false
      // continue
    // endif

    /// Ask for action input if not selected
    action_input currentPlayerTurn
    
    check_action_skip currentPlayerTurn
    goto_script "check_passive_triggers" "before_action"
    character_action currentPlayerTurn
    goto_script "check_passive_triggers" "after_action"
    wait 0.5
    
    // if enemy is defeated, end battle
    if #currentEnemyHp <= 0
      goto end
      goto_script "check_passive_triggers" "enemy_defeated"
    endif
  endfor

  // if enemy is defeated, go to new enemy
  // if #currentEnemyHp <= 0
    // goto end
    // goto_script "check_passive_triggers" "enemy_defeated"
  // endif


  // enemy turn
  set_var currentPlayerTurn 0
  enemy_attack_target
  goto_script "check_passive_triggers" "before_enemy_attack"
  enemy_attack
  goto_script "check_passive_triggers" "after_enemy_attack"


  goto_script "check_passive_triggers" "before_death_checks"
  goto end

  // goto start_new_turn
// endfor




waypoint end
fade_music 0 1
enable_input false

// play_sfx "date_end"

// actor_tint main 0 1 "white"
// actor_tint support 0 1 "white"
// goto end



// waypoint end
fade_music 0 1
fade_out 0.5

end_battle

bg null
fade_in 0.5
